<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CO‚ÇÇ Savings Calculator | Gold Standard</title>
  <meta name="description"
    content="CO‚ÇÇ savings calculator for WASH/energy projects in Least Developed Countries using Gold Standard methodology">

  <!-- Open Graph / Facebook / LinkedIn -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://washways.github.io/CO2SavingsCalculator/">
  <meta property="og:title" content="CO‚ÇÇ Savings Calculator | Gold Standard">
  <meta property="og:description"
    content="Estimate CO‚ÇÇ emission reductions from WASH and energy projects in Least Developed Countries using Gold Standard methodologies.">
  <meta property="og:image" content="https://washways.github.io/CO2SavingsCalculator/social-preview.png">

  <!-- Twitter Card -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://washways.github.io/CO2SavingsCalculator/">
  <meta property="twitter:title" content="CO‚ÇÇ Savings Calculator | Gold Standard">
  <meta property="twitter:description"
    content="Estimate CO‚ÇÇ emission reductions from WASH and energy projects in Least Developed Countries using Gold Standard methodologies.">
  <meta property="twitter:image" content="https://washways.github.io/CO2SavingsCalculator/social-preview.png">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --card: #ffffff;
      --border: #e2e8f0;
      --accent: #00bfa5;
      --accent2: #1cabe2;
      --warn: #f59e0b;
      --text: #0f172a;
      --muted: #475569;
      --tag: #f1f5f9;
      --red: #ef4444;
      --green: #10b981;
      --radius: 12px;
      --trans: 0.2s ease;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html {
      scroll-behavior: smooth
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
      line-height: 1.5
    }

    a {
      color: var(--accent2);
      text-decoration: none
    }

    select,
    input {
      font-family: 'Inter', sans-serif
    }

    /* Header */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .estimator-banner {
      background: #fef08a;
      color: #854d0e;
      text-align: center;
      padding: 8px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      position: sticky;
      top: 64px;
      z-index: 99;
      border-bottom: 1px solid #fde047;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px
    }

    .logo-text h1 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px
    }

    .logo-text p {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .badge {
      background: var(--tag);
      border: 1px solid var(--accent2);
      color: var(--accent2);
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 20px;
      letter-spacing: 0.5px
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 0;
      min-height: calc(100vh - 64px);
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 24px 48px
    }

    .main-col {
      min-width: 0;
      padding-right: 24px
    }

    .side-col {
      position: sticky;
      top: 88px;
      height: fit-content
    }

    /* Section titles */
    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin: 0 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border)
    }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      transition: var(--trans);
      box-shadow: var(--shadow);
    }

    .card:hover {
      border-color: var(--border)
    }

    /* Global params */
    .global-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px
    }

    .param-badge {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 2px
    }

    .param-badge label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .param-badge .val {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent)
    }

    .param-badge .sub {
      font-size: 10px;
      color: var(--muted)
    }

    /* Project type tabs */
    .ptype-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px
    }

    .ptype-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--trans);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px
    }

    .ptype-btn .icon {
      font-size: 20px
    }

    .ptype-btn.active {
      border-color: var(--accent2);
      background: rgba(28, 171, 226, 0.10);
      color: var(--accent2)
    }

    .ptype-btn:hover:not(.active) {
      border-color: var(--muted);
      color: var(--text)
    }

    /* Project params */
    .proj-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px
    }

    /* Form elements */
    .field {
      display: flex;
      flex-direction: column;
      gap: 5px
    }

    .field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.4px
    }

    .field input,
    .field select {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 9px 12px;
      color: var(--text);
      font-size: 13px;
      transition: var(--trans);
      width: 100%
    }

    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: var(--accent2);
      box-shadow: 0 0 0 3px rgba(28, 171, 226, 0.12)
    }

    .field select option {
      background: var(--card)
    }

    .field-hint {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px
    }

    /* Module cards */
    .module-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 14px;
      overflow: hidden;
      transition: var(--trans)
    }

    .module-card.active {
      border-color: rgba(0, 191, 165, 0.4)
    }

    .module-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none
    }

    .module-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0
    }

    .mod-A .module-icon {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b
    }

    .mod-B .module-icon {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444
    }

    .mod-C .module-icon {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981
    }

    .mod-D .module-icon {
      background: rgba(139, 92, 246, 0.15);
      color: #8b5cf6
    }

    .module-title {
      flex: 1
    }

    .module-title h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text)
    }

    .module-title p {
      font-size: 11px;
      color: var(--muted)
    }

    .module-result {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      min-width: 100px;
      text-align: right
    }

    .module-result .unit {
      font-size: 10px;
      color: var(--muted);
      font-weight: 400
    }

    /* Toggle switch */
    .toggle {
      position: relative;
      width: 40px;
      height: 22px;
      flex-shrink: 0
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--border);
      border-radius: 22px;
      cursor: pointer;
      transition: var(--trans)
    }

    .toggle-slider:before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      left: 3px;
      top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: var(--trans)
    }

    .toggle input:checked+.toggle-slider {
      background: var(--accent)
    }

    .toggle input:checked+.toggle-slider:before {
      transform: translateX(18px)
    }

    /* Module body */
    .module-body {
      padding: 0 20px 20px;
      display: none;
      animation: fadeIn 0.2s ease
    }

    .module-body.open {
      display: block
    }

    .module-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(155px, 1fr));
      gap: 10px;
      margin-top: 12px
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 14px 0
    }

    /* Results sidebar */
    .results-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .total-box {
      background: rgba(0, 191, 165, 0.08);
      border: 1px solid rgba(0, 191, 165, 0.3);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px
    }

    .total-box .label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .total-box .value {
      font-size: 36px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1.1;
      margin: 4px 0
    }

    .total-box .unit {
      font-size: 12px;
      color: var(--muted)
    }

    .module-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border)
    }

    #validation-alert {
      display: none;
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
    }

    .module-row:last-child {
      border-bottom: none
    }

    .module-row .name {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px
    }

    .module-row .amount {
      font-size: 13px;
      font-weight: 600;
      color: var(--text)
    }

    /* Bar chart */
    .bar-wrap {
      margin: 14px 0
    }

    .bar-item {
      margin-bottom: 8px
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 3px;
      color: var(--muted)
    }

    .bar-track {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden
    }

    .bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease
    }

    .fill-A {
      background: #f59e0b
    }

    .fill-C {
      background: #ef4444
    }

    .fill-D {
      background: #10b981
    }

    .fill-E {
      background: #8b5cf6
    }

    /* Equivalencies */
    .equiv-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 14px
    }

    .equiv-item {
      background: var(--surface);
      border-radius: 8px;
      padding: 10px;
      text-align: center
    }

    .equiv-item .eico {
      font-size: 20px;
      margin-bottom: 4px
    }

    .equiv-item .eval {
      font-size: 15px;
      font-weight: 700;
      color: var(--accent2)
    }

    .equiv-item .elab {
      font-size: 10px;
      color: var(--muted)
    }

    /* Export */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--trans);
      border: none;
      font-family: inherit
    }

    .btn-primary {
      background: var(--accent);
      color: #000
    }

    .btn-primary:hover {
      background: #00d4b8
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted)
    }

    .btn-outline:hover {
      border-color: var(--accent2);
      color: var(--accent2)
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap
    }

    /* Methodology note */
    .method-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--muted);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 3px 8px;
      border-radius: 4px;
      margin-bottom: 10px
    }

    /* Info tooltip */
    .info {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--border);
      color: var(--muted);
      font-size: 9px;
      text-align: center;
      line-height: 14px;
      cursor: help;
      flex-shrink: 0
    }

    /* Responsive */
    @media(max-width:820px) {
      .app {
        grid-template-columns: 1fr
      }

      .main-col {
        padding-right: 0
      }

      .side-col {
        position: static
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-6px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    /* Inline formula display */
    .formula-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 11px;
      color: var(--muted);
      font-family: monospace;
      margin-top: 8px;
      line-height: 1.8
    }

    .formula-box b {
      color: var(--accent)
    }

    .result-inline {
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
      background: rgba(0, 191, 165, 0.08);
      border: 1px solid rgba(0, 191, 165, 0.2);
      border-radius: 6px;
      padding: 4px 10px;
      margin-top: 8px
    }

    .result-inline .rv {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent)
    }

    .result-inline .ru {
      font-size: 11px;
      color: var(--muted)
    }

    /* Splash Screen */
    .splash-overlay {
      position: fixed;
      inset: 0;
      background: rgba(248, 250, 252, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .splash-card {
      background: var(--surface);
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border);
      margin: 20px;
    }

    .splash-card h2 {
      font-size: 24px;
      color: var(--text);
      margin-bottom: 16px;
      font-weight: 800;
    }

    .splash-card p {
      font-size: 15px;
      color: var(--muted);
      margin-bottom: 30px;
      line-height: 1.6;
    }

    /* Added Details for portfolio mode */
    .advanced-assumptions {
      margin-top: 20px;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
    }

    .advanced-assumptions summary {
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      list-style: none;
    }

    .advanced-assumptions summary::-webkit-details-marker {
      display: none;
    }

    .assump-head {
      font-size: 11px;
      color: var(--accent2);
      margin: 16px 0 12px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      padding-bottom: 6px;
    }
  </style>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåç</text></svg>">
</head>

<body>

  <div id="splash" class="splash-overlay">
    <div class="splash-card">
      <div class="logo-icon"
        style="width:64px;height:64px;font-size:32px;margin:0 auto 20px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        üåç</div>
      <h2>CO‚ÇÇ Savings Calculator</h2>
      <p style="margin-bottom: 20px;">Estimate greenhouse gas reductions from WASH and institutional energy projects in
        Least Developed Countries using Gold Standard methodologies.</p>

      <div
        style="text-align: left; font-size: 13px; color: var(--muted); margin-bottom: 30px; background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
        <strong style="color: var(--text); font-size: 14px;">Purpose & Capabilities:</strong>
        <ul style="margin-top: 10px; padding-left: 20px; display: flex; flex-direction: column; gap: 8px;">
          <li><strong>Portfolio Aggregation:</strong> Effortlessly calculate aggregated savings across entire portfolios
            of clinics, schools, and household clusters simultaneously.</li>
          <li><strong>Strict Methodology:</strong> Built-in guardrails against double counting and rigorous adherence to
            mass-based emission factors (kgCO‚ÇÇe/kg fuel). NCV is used only to convert energy needs into fuel mass where
            required.</li>
          <li><strong>Financial Tracking:</strong> Automatically estimates indicative voluntary carbon market revenues
            and lifetime avoided fuel spending.</li>
          <li><strong>Dashboard Ready:</strong> Export transparent, detailed CSV reports capturing over 60 granular
            assumptions.</li>
        </ul>
      </div>
      <button class="btn btn-primary"
        onclick="document.getElementById('splash').style.opacity='0'; setTimeout(()=>document.getElementById('splash').style.visibility='hidden', 500);"
        style="padding:12px 28px; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Start Tool &rarr;</button>
    </div>
  </div>

  <header>
    <div class="logo">
      <div class="logo-icon">üåç</div>
      <div class="logo-text">
        <h1>CO‚ÇÇ Savings Calculator</h1>
        <p>WASH &amp; Energy ¬∑ Gold Standard Methodology</p>
      </div>
    </div>
    <div class="header-right">
      <a href="https://github.com/washways/CO2SavingsCalculator#readme" target="_blank" class="badge"
        style="background:#fff; color:var(--text); border-color:var(--border); display:flex; align-items:center; gap:4px; font-size:11px;">
        <span>üìñ</span> Documentation ‚Üó
      </a>
      <span class="badge">LDC Countries</span>
      <span class="badge" style="border-color:var(--accent);color:var(--accent)">Gold Standard</span>
    </div>
  </header>

  <div class="estimator-banner">‚ö†Ô∏è SCREENING ESTIMATOR ONLY: Indicative results for planning. Not for certified carbon
    issuance.</div>

  <div class="app">
    <div class="main-col">

      <!-- GLOBAL PARAMETERS -->
      <div class="card">
        <div class="section-title">üåê Global Parameters</div>
        <div class="proj-grid" style="margin-bottom:14px">
          <div class="field">
            <label>Country (LDC) <span class="info" title="Only UN-listed Least Developed Countries">i</span></label>
            <select id="country" onchange="onCountryChange()"></select>
          </div>
          <div class="field">
            <label>Project Currency Year</label>
            <select id="creditYear">
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div class="field">
            <label>Project Lifetime (years)</label>
            <input type="number" id="lifetime" value="10" min="1" max="30" onchange="recalc()">
          </div>
          <div class="field">
            <label>Carbon Price ($/tCO‚ÇÇe) <span class="info" title="Voluntary Carbon Market Price">i</span></label>
            <input type="number" id="carbon-price" value="10" min="0" step="0.5" onchange="recalc()">
          </div>

        </div>
        <div class="global-grid" id="globalBadges">
          <div class="param-badge"><label>fNRB <span class="info"
                title="Fraction Non-Renewable Biomass ‚Äî Gold Standard/CDM country default">i</span></label>
            <div class="val" id="badge-fnrb">‚Äì</div>
            <div class="sub">biomass non-renewable fraction</div>
          </div>
          <div class="param-badge"><label>Grid EF <span class="info"
                title="Grid emission factor from IEA data (kgCO‚ÇÇ/kWh)">i</span></label>
            <div class="val" id="badge-grid">‚Äì</div>
            <div class="sub">kgCO‚ÇÇ/kWh</div>
          </div>
          <div class="param-badge"><label>Region</label>
            <div class="val" id="badge-region" style="font-size:13px">‚Äì</div>
            <div class="sub">UN classification</div>
          </div>
          <div class="param-badge"><label>Main Cooking Fuel</label>
            <div class="val" id="badge-fuel" style="font-size:13px">‚Äì</div>
            <div class="sub">country baseline</div>
          </div>
        </div>

        <div class="section-title" style="margin-top:20px; border-bottom:none; padding-bottom:0;">‚õΩ Local Fuel Prices
          (Optional overrides)</div>
        <div class="proj-grid" style="margin-top:10px;">
          <div class="field">
            <label>Firewood ($/kg)</label>
            <input type="number" id="price-wood" value="0.05" min="0" step="0.01" onchange="recalc()">
          </div>
          <div class="field">
            <label>Charcoal ($/kg)</label>
            <input type="number" id="price-charcoal" value="0.20" min="0" step="0.01" onchange="recalc()">
          </div>
          <div class="field">
            <label>LPG ($/kg)</label>
            <input type="number" id="price-lpg" value="1.00" min="0" step="0.05" onchange="recalc()">
          </div>
          <div class="field">
            <label>Kerosene ($/L)</label>
            <input type="number" id="price-kerosene" value="0.80" min="0" step="0.05" onchange="recalc()">
          </div>
          <div class="field">
            <label>Diesel ($/L)</label>
            <input type="number" id="price-diesel" value="1.10" min="0" step="0.05" onchange="recalc()">
          </div>
        </div>
      </div>

      <!-- PROJECT TYPE -->
      <div class="card">
        <div class="section-title">üèó Project Portfolio</div>

        <div
          style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 20px;">
          <div class="field"
            style="background:var(--bg); border:1px solid var(--border); padding:16px; border-radius:8px;">
            <label
              style="font-size:13px; color:var(--text); margin-bottom:8px; display:flex; justify-content:space-between;"><span>üè•
                Health Care Facilities</span> <input type="number" id="port-hcfs" value="0" min="0"
                onchange="onTypeParamChange()" style="width:60px; padding:4px 8px;"></label>
            <div style="display:block; text-align:left; margin-top:12px; padding-left:4px;">
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-hcf-water" checked onchange="onTypeParamChange()">
                Solar Water Pumping</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-hcf-san" checked onchange="onTypeParamChange()">
                Inst. Sanitation</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-hcf-cook" checked onchange="onTypeParamChange()">
                Induction Cooking</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-hcf-light" checked onchange="onTypeParamChange()">
                Solar Lighting</label>
            </div>
          </div>
          <div class="field"
            style="background:var(--bg); border:1px solid var(--border); padding:16px; border-radius:8px;">
            <label
              style="font-size:13px; color:var(--text); margin-bottom:8px; display:flex; justify-content:space-between;"><span>üè´
                Schools / Institutions</span> <input type="number" id="port-schools" value="0" min="0"
                onchange="onTypeParamChange()" style="width:60px; padding:4px 8px;"></label>
            <div style="display:block; text-align:left; margin-top:12px; padding-left:4px;">
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-sch-water" checked onchange="onTypeParamChange()">
                Solar Water Pumping</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-sch-san" checked onchange="onTypeParamChange()">
                Inst. Sanitation</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-sch-cook" checked onchange="onTypeParamChange()">
                Induction Cooking</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-sch-light" checked onchange="onTypeParamChange()">
                Solar Lighting</label>
            </div>
          </div>
          <div class="field"
            style="background:var(--bg); border:1px solid var(--border); padding:16px; border-radius:8px;">
            <label
              style="font-size:13px; color:var(--text); margin-bottom:8px; display:flex; justify-content:space-between;"><span>üèò
                Household Clusters</span> <input type="number" id="port-hhs" value="0" min="0"
                onchange="onTypeParamChange()" style="width:60px; padding:4px 8px;"></label>
            <div style="display:block; text-align:left; margin-top:12px; padding-left:4px;">
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-hh-cook" checked onchange="onTypeParamChange()">
                Improved Cook Stoves</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-hh-ind" checked onchange="onTypeParamChange()">
                Induction Cooker + Solar</label>
              <label
                style="font-size:12px; font-weight:400; text-transform:none; color:var(--muted); display:flex; align-items:center; margin-bottom:10px; cursor:pointer;"><input
                  type="checkbox" style="margin:0 8px 0 0; " id="chk-hh-san" checked onchange="onTypeParamChange()"> HH
                Sanitation</label>
            </div>
          </div>
        </div>

        <details class="advanced-assumptions">
          <summary>‚öôÔ∏è Advanced Unit Assumptions (Expand)</summary>
          <h4 class="assump-head">Average per HCF</h4>
          <!-- HCF params -->
          <div id="params-HCF" class="proj-grid">
            <div class="field"><label>Inpatient Beds</label><input type="number" id="hcf-beds" value="50" min="1"
                onchange="onTypeParamChange()"></div>
            <div class="field"><label>Daily OPD Visits</label><input type="number" id="hcf-opd" value="100" min="0"
                onchange="onTypeParamChange()"></div>
            <div class="field"><label>Staff on Site</label><input type="number" id="hcf-staff" value="30" min="0"
                onchange="onTypeParamChange()"></div>
            <div class="field"><label>Operating Days/Year</label><input type="number" id="hcf-days" value="365" min="1"
                max="365" onchange="onTypeParamChange()"></div>
          </div>
          <!-- School params -->
          <div id="params-School" class="proj-grid">
            <div class="field"><label>Enrolment (pupils)</label><input type="number" id="sch-pupils" value="400" min="1"
                onchange="onTypeParamChange()"></div>
            <div class="field"><label>Teaching Days/Year</label><input type="number" id="sch-days" value="200" min="1"
                max="365" onchange="onTypeParamChange()"></div>
            <div class="field"><label>School Meals/Day</label><input type="number" id="sch-meals" value="400" min="0"
                onchange="onTypeParamChange()"></div>
            <div class="field"><label>Teachers / Staff</label><input type="number" id="sch-staff" value="20" min="0"
                onchange="onTypeParamChange()"></div>
          </div>
          <h4 class="assump-head">Per Household Cluster</h4>
          <!-- HH params -->
          <div id="params-HH" class="proj-grid">
            <div class="field"><label>No. of Households</label><input type="number" id="hh-count" value="50" min="1"
                onchange="onTypeParamChange()"></div>
            <div class="field"><label>Avg HH Size (persons)</label><input type="number" id="hh-size" value="5" min="1"
                max="20" onchange="onTypeParamChange()"></div>
            <div class="field"><label>Settlement Type</label>
              <select id="hh-settle" onchange="onTypeParamChange()">
                <option value="rural">Rural</option>
                <option value="peri">Peri-urban</option>
                <option value="urban">Urban</option>
              </select>
            </div>
          </div>
          <h4 class="assump-head">Water Systems (Community & Boiling)</h4>
          <div id="params-Water" class="proj-grid">
            <div class="field"><label>Community Size (per system)</label><input type="number" id="A-comm-pop"
                value="3000" min="0" step="100" onchange="onTypeParamChange()"></div>
          </div>
        </details>
      </div>

      <!-- ACTIVE MODULES TOGGLES -->
      <div class="card" style="margin-bottom: 24px;">
        <div class="section-title">‚ö° Active Calculation Modules <span class="info"
            title="Switch off specific calculation tools globally. Inactive modules will contribute 0 to the total.">i</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <label class="toggle"><input type="checkbox" id="tog-A" onchange="toggleModule('A')" checked><span
                class="toggle-slider"></span></label>
            <span style="font-weight:600; font-size:13px; color:var(--text);">Module A (Water Pumping)</span>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <label class="toggle"><input type="checkbox" id="tog-B" onchange="toggleModule('B')" checked><span
                class="toggle-slider"></span></label>
            <span style="font-weight:600; font-size:13px; color:var(--text);">Module B (Avoided Boiling)</span>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <label class="toggle"><input type="checkbox" id="tog-C" onchange="toggleModule('C')" checked><span
                class="toggle-slider"></span></label>
            <span style="font-weight:600; font-size:13px; color:var(--text);">Module C (Inst. Cooking)</span>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <label class="toggle"><input type="checkbox" id="tog-D" onchange="toggleModule('D')" checked><span
                class="toggle-slider"></span></label>
            <span style="font-weight:600; font-size:13px; color:var(--text);">Module D (Sanitation)</span>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <label class="toggle"><input type="checkbox" id="tog-E" onchange="toggleModule('E')" checked><span
                class="toggle-slider"></span></label>
            <span style="font-weight:600; font-size:13px; color:var(--text);">Module E (HH Cookstoves)</span>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <label class="toggle"><input type="checkbox" id="tog-F" onchange="toggleModule('F')" checked><span
                class="toggle-slider"></span></label>
            <span style="font-weight:600; font-size:13px; color:var(--text);">Module F (Inst. Lighting)</span>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <label class="toggle"><input type="checkbox" id="tog-G" onchange="toggleModule('G')" checked><span
                class="toggle-slider"></span></label>
            <span style="font-weight:600; font-size:13px; color:var(--text);">Module G (HH Induction)</span>
          </div>
        </div>
      </div>

      <!-- MODULES HEADING -->
      <div class="section-title" style="margin-top:8px">‚ö° Emission Reduction Modules</div>

      <!-- MODULE A: SOLAR WATER PUMPING -->
      <div class="module-card mod-A" id="card-A">
        <div class="module-header" onclick="toggleBody('A')">
          <div class="module-icon">‚ö°</div>
          <div class="module-title">
            <h3>A ‚Äî Solar Water Pumping</h3>
            <p>AMS-I.F / CDM AM0020 ¬∑ Diesel or grid pump displacement</p>
          </div>
          <div class="module-result"><span id="result-A">0</span><br><span class="unit">tCO‚ÇÇe/yr</span></div>
        </div>
        <div class="module-body open" id="body-A">
          <div class="method-tag"><a href="https://cdm.unfccc.int/methodologies/DB/9KJWQ1G0WEG6LKHX21MLPS8BQR7242"
              target="_blank" style="color:inherit;text-decoration:none;">üìã Gold Standard AMS-I.F / CDM AM0020
              (Pumping) ‚Üó</a>
            <br><a
              href="https://globalgoals.goldstandard.org/standards/443_v1.0_ee_gs-methodology-for-emission-reductions-from-safe-drinking-water-supply/"
              target="_blank" style="color:inherit;text-decoration:none;">üìã Gold Standard Safe Water Supply Methodology
              (Avoided Boiling) ‚Üó</a>
          </div>
          <div style="margin: 0 0 16px 0; background: #eef2f5; padding: 12px; border-radius: 6px;">
            <strong>Total Population Served (HCFs, Schools, & Community): </strong><span id="A-total-pop"
              style="font-weight: bold; color: var(--primary);">0</span> persons
          </div>
          <div class="module-grid">
            <div class="field"><label>Baseline Pump Type</label>
              <select id="A-baseline" onchange="recalc()">
                <option value="diesel">Diesel pump</option>
                <option value="grid">Grid electric pump</option>
              </select>
            </div>
            <div class="field"><label>Daily Water Demand (m¬≥/day) <span class="info"
                  title="Calculated from Population Served &#10;(WHO norms: 75L/bed, 5L/opd, 3L/pupil, 20L/HH)">i</span></label><input
                type="number" id="A-demand" value="10" min="0" step="0.5" onchange="recalc()"></div>
            <div class="field"><label>Total Dynamic Head (m)</label><input type="number" id="A-head" value="25" min="0"
                onchange="recalc()"></div>
            <div class="field"><label>Operating Days/Year</label><input type="number" id="A-days" value="365" min="1"
                max="365" onchange="recalc()"></div>
          </div>
          <div class="module-grid">
            <div class="field"><label>Pump Efficiency Œ∑ <span class="info"
                  title="Hydraulic pump efficiency (0.5‚Äì0.75 typical)">i</span></label><input type="number"
                id="A-etapump" value="0.60" min="0.1" max="1" step="0.05" onchange="recalc()"></div>
            <div class="field" id="A-diesel-field"><label>Diesel Engine Œ∑ <span class="info"
                  title="Overall diesel genset thermal efficiency">i</span></label><input type="number" id="A-etadiesel"
                value="0.30" min="0.1" max="0.5" step="0.01" onchange="recalc()"></div>
            <div class="field" id="A-grid-field" style="display:none"><label>Motor Efficiency Œ∑</label><input
                type="number" id="A-etamotor" value="0.90" min="0.5" max="1" step="0.01" onchange="recalc()"></div>
          </div>
          <div class="formula-box" id="A-formula">ER = BE ¬∑ <b>0 tCO‚ÇÇe</b> (solar PE = 0)</div>
          <div class="result-inline"><span class="rv" id="A-detail">0</span><span class="ru">tCO‚ÇÇe / year saved</span>
          </div>
        </div>
      </div>

      <!-- MODULE B: AVOIDED BOILING -->
      <div class="module-card mod-A" id="card-B">
        <div class="module-header" onclick="toggleBody('B')">
          <div class="module-icon" style="background:rgba(239, 68, 68, 0.15); color:#ef4444">‚ô®Ô∏è</div>
          <div class="module-title">
            <h3>B ‚Äî Avoided Boiling</h3>
            <p>AMS-I.E / AMS-III.G ¬∑ Avoided biomass for water purification</p>
          </div>
          <div class="module-result"><span id="result-B">0</span><br><span class="unit">tCO‚ÇÇe/yr</span></div>
        </div>
        <div class="module-body open" id="body-B">
          <div class="method-tag"><a
              href="https://globalgoals.goldstandard.org/standards/443_v1.0_ee_gs-methodology-for-emission-reductions-from-safe-drinking-water-supply/"
              target="_blank" style="color:inherit;text-decoration:none;">üìã Gold Standard Safe Water Supply Methodology
              (Avoided Boiling) ‚Üó</a>
          </div>
          <div style="margin: 0 0 16px 0; background: #eef2f5; padding: 12px; border-radius: 6px;">
            <strong>Total Population Served (HCFs, Schools, & Community): </strong><span id="B-total-pop"
              style="font-weight: bold; color: var(--primary);">0</span> persons
          </div>
          <div class="module-grid">
            <div class="field"><label>Drinking Water Boiled (L/person/day)</label><input type="number" id="B-boil-vol"
                value="2.0" min="0" step="0.5" onchange="recalc()"></div>
            <div class="field"><label>Baseline Boiling Fuel</label>
              <select id="B-fuel" onchange="recalc()">
                <option value="wood">Firewood</option>
                <option value="charcoal">Charcoal</option>
              </select>
            </div>
            <div class="field"><label>Baseline Stove Œ∑</label><input type="number" id="B-boil-eta" value="0.10"
                min="0.05" step="0.01" max="1" onchange="recalc()"></div>
          </div>
          <div class="formula-box" id="B-formula">Avoided Boiling = <b>0 tCO‚ÇÇe/yr</b></div>
          <div class="result-inline"><span class="rv" id="B-detail">0</span><span class="ru">tCO‚ÇÇe / year saved</span>
          </div>
          <p class="info-text"
            style="font-size:11px;color:var(--muted);margin-top:12px;border-top:1px solid var(--border);padding-top:8px;">
            Fuel EFs used are mass-based (kgCO‚ÇÇe/kg fuel). NCV is stored for future use but not applied to mass-based
            EFs.</p>
        </div>
      </div>

      <!-- MODULE B: INSTITUTIONAL INDUCTION COOKING -->
      <div class="module-card mod-B" id="card-C">
        <div class="module-header" onclick="toggleBody('C')">
          <div class="module-icon">üç≥</div>
          <div class="module-title">
            <h3>C ‚Äî Institutional Induction Cooking</h3>
            <p>Gold Standard MECD ¬∑ Replaces charcoal/wood/LPG cooking</p>
          </div>
          <div class="module-result"><span id="result-C">0</span><br><span class="unit">tCO‚ÇÇe/yr</span></div>
        </div>
        <div class="module-body open" id="body-C">
          <div class="method-tag"><a
              href="https://globalgoals.goldstandard.org/standards/431_V1.2_TC_EE_ICS_Methodology-for-Metered-and-Measured-Energy-Cooking-Devices.pdf"
              target="_blank" style="color:inherit;text-decoration:none;">üìã Gold Standard MECD v1.2 (Metered &amp;
              Measured Energy Cooking Devices) ‚Üó</a></div>
          <div style="margin: 0 0 16px 0; background: #eef2f5; padding: 12px; border-radius: 6px;">
            <strong>Total Population Served (HCFs & Schools): </strong><span id="C-total-pop"
              style="font-weight: bold; color: var(--primary);">0</span> persons
          </div>
          <div class="module-grid">
            <div class="field"><label>Baseline Fuel</label>
              <select id="C-fuel" onchange="recalc()">
                <option value="charcoal">Charcoal</option>
                <option value="wood">Firewood (3-stone)</option>
                <option value="lpg">LPG</option>
                <option value="kerosene">Kerosene</option>
              </select>
            </div>
            <div class="field"><label>Daily Fuel Consumption (kg) <span class="info"
                  title="Calculated from population and institution type meals/day.">i</span></label><input
                type="number" id="C-fuelkg" value="30" min="0" step="1" onchange="recalc()"></div>
            <div class="field"><label>Cooking Days/Year</label><input type="number" id="C-days" value="300" min="1"
                max="365" onchange="recalc()"></div>
            <div class="field"><label>Electricity Source</label>
              <select id="C-elec" onchange="recalc()">
                <option value="solar">Solar PV (zero PE)</option>
                <option value="grid">Grid electricity</option>
              </select>
            </div>
          </div>
          <div class="module-grid" id="C-grid-fields" style="display:none">
            <div class="field"><label>Annual Electricity Use (kWh/yr)</label><input type="number" id="C-kwh"
                value="5000" min="0" onchange="recalc()"></div>
          </div>
          <div class="formula-box" id="C-formula">BE = FC √ó NCV √ó EF √ó fNRB ‚Äî PE</div>
          <div class="result-inline"><span class="rv" id="C-detail">0</span><span class="ru">tCO‚ÇÇe / year saved</span>
          </div>
          <p class="info-text"
            style="font-size:11px;color:var(--muted);margin-top:12px;border-top:1px solid var(--border);padding-top:8px;">
            Fuel EFs used are mass-based (kgCO‚ÇÇe/kg fuel). NCV is stored for future use but not applied to mass-based
            EFs.</p>
        </div>
      </div>

      <!-- MODULE C: SANITATION (MERGED) -->
      <div class="module-card mod-C" id="card-D">
        <div class="module-header" onclick="toggleBody('D')">
          <div class="module-icon">üöΩ</div>
          <div class="module-title">
            <h3>D ‚Äî Sanitation Methane Reduction</h3>
            <p>IPCC Tier 1 ¬∑ Institutional + HH scale separated</p>
          </div>
          <div class="module-result"><span id="result-D">0</span><br><span class="unit">tCO‚ÇÇe/yr</span></div>
        </div>
        <div class="module-body open" id="body-D">
          <div class="method-tag"><a href="https://www.goldstandard.org/project-developers/standard-documents"
              target="_blank" style="color:inherit;text-decoration:none;">üìã IPCC 2006 Waste Ch.6 ¬∑ Gold Standard
              Integrated SDG Sanitation ‚Üó</a></div>
          <div style="margin: 0 0 16px 0; background: #eef2f5; padding: 12px; border-radius: 6px;">
            <strong>Total Population Served (Institutional + Household): </strong><span id="D-total-pop"
              style="font-weight: bold; color: var(--primary);">0</span> persons
          </div>
          <input type="hidden" id="D-pop-inst" value="0">
          <input type="hidden" id="D-pop-hh" value="0">
          <div class="module-grid"
            style="background:var(--bg); padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:12px;">
            <div style="grid-column: 1 / -1; font-weight:600; font-size:12px; color:var(--accent2); margin-bottom:4px;">
              üè•üè´ Institutional Sanitation</div>
            <div class="field"><label>Baseline System</label>
              <select id="D-baseline-inst" onchange="recalc()">
                <option value="openwater">Open defecation near water (MCF 0.3)</option>
                <option value="opendry">Open defecation dry field (MCF 0.05)</option>
                <option value="sharedpit">Unimproved shared pit (MCF 0.5)</option>
                <option value="septic">Septic / pour-flush (MCF 0.5)</option>
              </select>
            </div>
            <div class="field"><label>Improved System</label>
              <select id="D-improved-inst" onchange="recalc()">
                <option value="vip">VIP / dry pit with slab (MCF 0.05)</option>
                <option value="ecosan">Composting / EcoSan (MCF 0.01)</option>
                <option value="biogas">Biogas digester ‚Äì capture (MCF 0.1)</option>
                <option value="sewer">Sewer to aerobic WWTP (MCF 0.0)</option>
              </select>
            </div>
          </div>

          <div class="module-grid"
            style="background:var(--bg); padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:12px;">
            <div style="grid-column: 1 / -1; font-weight:600; font-size:12px; color:var(--accent2); margin-bottom:4px;">
              üèò Household Sanitation</div>
            <div class="field"><label>Baseline System</label>
              <select id="D-baseline-hh" onchange="recalc()">
                <option value="openwater">Open defecation near water (MCF 0.3)</option>
                <option value="opendry">Open defecation dry field (MCF 0.05)</option>
                <option value="sharedpit" selected>Unimproved shared pit (MCF 0.5)</option>
                <option value="septic">Septic / pour-flush (MCF 0.5)</option>
              </select>
            </div>
            <div class="field"><label>Improved System</label>
              <select id="D-improved-hh" onchange="recalc()">
                <option value="vip">VIP / dry pit with slab (MCF 0.05)</option>
                <option value="ecosan">Composting / EcoSan (MCF 0.01)</option>
                <option value="biogas">Biogas digester ‚Äì capture (MCF 0.1)</option>
                <option value="sewer">Sewer to aerobic WWTP (MCF 0.0)</option>
              </select>
            </div>
          </div>
          <div class="module-grid">
            <div class="field"><label>BOD Load (g/person/day) <span class="info"
                  title="IPCC default: 40 g BOD/person/day">i</span></label><input type="number" id="D-bod" value="40"
                min="10" max="80" step="5" onchange="recalc()"></div>
            <div class="field"><label>Bo ‚Äî Max CH‚ÇÑ potential <span class="info"
                  title="IPCC default: 0.6 kg CH4/kg BOD">i</span></label><input type="number" id="D-bo" value="0.6"
                min="0.1" max="0.8" step="0.05" onchange="recalc()"></div>
          </div>
          <div class="formula-box" id="D-formula">ER = U √ó BOD √ó Bo √ó (MCF_base ‚Äì MCF_imp) √ó GWP‚ÇÇ‚Çà / 1000</div>
          <div class="result-inline"><span class="rv" id="D-detail">0</span><span class="ru">tCO‚ÇÇe / year saved</span>
          </div>
        </div>
      </div>

      <!-- MODULE D: IMPROVED HH COOKSTOVES -->
      <div class="module-card mod-D" id="card-E">
        <div class="module-header" onclick="toggleBody('E')">
          <div class="module-icon">üî•</div>
          <div class="module-title">
            <h3>E ‚Äî Improved HH Cookstoves</h3>
            <p>Gold Standard TPDDTEC / RECH ¬∑ fNRB biomass displacement</p>
          </div>
          <div class="module-result"><span id="result-E">0</span><br><span class="unit">tCO‚ÇÇe/yr</span></div>
        </div>
        <div class="module-body open" id="body-E">
          <div class="method-tag"><a
              href="https://globalgoals.goldstandard.org/standards/407_V4.0_EE_ICS_Reduced-Emissions-from-Cooking-and-Heating-TPDDTEC.pdf"
              target="_blank" style="color:inherit;text-decoration:none;">üìã Gold Standard TPDDTEC v4 / RECH ¬∑ AMS-II.G
              ‚Üó</a></div>
          <div style="margin: 0 0 16px 0; background: #eef2f5; padding: 12px; border-radius: 6px;">
            <strong>Total Population Served (Household Clusters): </strong><span id="E-total-pop"
              style="font-weight: bold; color: var(--primary);">0</span> persons
          </div>
          <input type="hidden" id="E-stoves" value="0">
          <div class="module-grid">
            <div class="field"><label>Fuel Type</label>
              <select id="E-fuel" onchange="recalc()">
                <option value="wood">Firewood</option>
                <option value="charcoal">Charcoal</option>
              </select>
            </div>
            <div class="field"><label>Baseline Fuel (kg/HH/day)</label><input type="number" id="E-baseline-fc"
                value="4.0" min="0.5" step="0.5" onchange="recalc()"></div>
            <div class="field"><label>Baseline Stove Type</label>
              <select id="E-base-stove" onchange="recalc()">
                <option value="0.10">3-stone open fire (Œ∑ 10%)</option>
                <option value="0.18">Traditional clay stove (Œ∑ 18%)</option>
                <option value="0.22">Traditional char jiko (Œ∑ 22%)</option>
              </select>
            </div>
          </div>
          <div class="module-grid">
            <div class="field"><label>Improved Stove Type</label>
              <select id="E-imp-stove" onchange="recalc()">
                <option value="0.25">Improved ICS (Œ∑ 25%)</option>
                <option value="0.35">Rocket stove (Œ∑ 35%)</option>
                <option value="0.40">Gasifier stove (Œ∑ 40%)</option>
                <option value="0.55">LPG / clean fuel (Œ∑ 55%)</option>
              </select>
            </div>
            <div class="field"><label>fNRB (auto from country) <span class="info"
                  title="Fraction of non-renewable biomass ‚Äî Gold Standard default by country">i</span></label><input
                type="number" id="E-fnrb" value="0.80" min="0" max="1" step="0.01" onchange="recalc()"></div>
            <div class="field"><label>Stacking Discount <span class="info"
                  title="Gold Standard default 20% discount for parallel old-stove use">i</span></label><input
                type="number" id="E-stack" value="0.20" min="0" max="0.5" step="0.05" onchange="recalc()"></div>
          </div>
          <div class="formula-box" id="E-formula">ER = N √ó FS √ó NCV √ó fNRB √ó (EF_CO‚ÇÇ+EF_nonCO‚ÇÇ) √ó (1‚Äìstacking)</div>
          <div class="result-inline"><span class="rv" id="E-detail">0</span><span class="ru">tCO‚ÇÇe / year saved</span>
          </div>
          <p class="info-text"
            style="font-size:11px;color:var(--muted);margin-top:12px;border-top:1px solid var(--border);padding-top:8px;">
            Fuel EFs used are mass-based (kgCO‚ÇÇe/kg fuel). NCV is stored for future use but not applied to mass-based
            EFs.</p>
        </div>
      </div>


      <!-- MODULE E: INSTITUTIONAL SOLAR LIGHTING -->
      <div class="module-card mod-A" id="card-F">
        <div class="module-header" onclick="toggleBody('F')">
          <div class="module-icon" style="background:rgba(250,204,21,0.15); color:#eab308">üí°</div>
          <div class="module-title">
            <h3>F ‚Äî Institutional Solar Lighting</h3>
            <p>AMS-III.AR / Standalone ¬∑ Replaces Kerosene/Diesel</p>
          </div>
          <div class="module-result"><span id="result-F">0</span><br><span class="unit">tCO‚ÇÇe/yr</span></div>
        </div>
        <div class="module-body open" id="body-F">
          <div class="method-tag"><a href="https://cdm.unfccc.int/methodologies/DB/S3RZMK6KR289WKK0VB1ETT6K73Y3DR"
              target="_blank" style="color:inherit;text-decoration:none;">üìã Gold Standard AMS-III.AR (simplified) ‚Üó</a>
          </div>
          <div style="margin: 0 0 16px 0; background: #eef2f5; padding: 12px; border-radius: 6px;">
            <strong>Total Population Served (HCFs & Schools): </strong><span id="F-total-pop"
              style="font-weight: bold; color: var(--primary);">0</span> persons
          </div>
          <input type="hidden" id="F-count" value="0">
          <div class="module-grid">
            <div class="field"><label>Baseline Fuel System</label>
              <select id="F-baseline" onchange="recalc()">
                <option value="kerosene">Kerosene Lamps</option>
                <option value="diesel">Diesel Gen-set</option>
              </select>
            </div>
            <div class="field"><label>Baseline Emissions/Facility (tCO‚ÇÇe/yr)</label><input type="number" id="F-ef"
                value="2.5" min="0.1" step="0.1" onchange="recalc()"></div>
          </div>
          <div class="formula-box" id="F-formula">ER = Facilities √ó ER_baseline</div>
          <div class="result-inline"><span class="rv" id="F-detail">0</span><span class="ru">tCO‚ÇÇe / year saved</span>
          </div>
        </div>
      </div>

      <!-- MODULE F: HH INDUCTION COOKING + SOLAR -->
      <div class="module-card mod-B" id="card-G">
        <div class="module-header" onclick="toggleBody('G')">
          <div class="module-icon" style="background:rgba(236,72,153,0.15); color:#db2777">‚òÄÔ∏è</div>
          <div class="module-title">
            <h3>G ‚Äî HH Induction Cooking + Solar</h3>
            <p>MECD ¬∑ Replaces household biomass</p>
          </div>
          <div class="module-result"><span id="result-G">0</span><br><span class="unit">tCO‚ÇÇe/yr</span></div>
        </div>
        <div class="module-body" id="body-G">
          <div class="method-tag"><a
              href="https://globalgoals.goldstandard.org/standards/431_V1.2_TC_EE_ICS_Methodology-for-Metered-and-Measured-Energy-Cooking-Devices.pdf"
              target="_blank" style="color:inherit;text-decoration:none;">üìã Gold Standard MECD v1.2 (Household Scale)
              ‚Üó</a>
          </div>
          <div style="margin: 0 0 16px 0; background: #eef2f5; padding: 12px; border-radius: 6px;">
            <strong>Total Population Served (Household Clusters): </strong><span id="G-total-pop"
              style="font-weight: bold; color: var(--primary);">0</span> persons
          </div>
          <input type="hidden" id="G-count" value="0">
          <div class="module-grid">
            <div class="field"><label>Baseline Fuel</label>
              <select id="G-fuel" onchange="recalc()">
                <option value="wood">Firewood</option>
                <option value="charcoal">Charcoal</option>
              </select>
            </div>
            <div class="field"><label>Baseline Fuel per HH (kg/day)</label><input type="number" id="G-fc" value="4.0"
                min="0.5" step="0.5" onchange="recalc()"></div>
          </div>
          <div class="formula-box" id="G-formula">ER = HHs √ó FC √ó NCV √ó EF √ó fNRB (Solar PE=0)</div>
          <div class="result-inline"><span class="rv" id="G-detail">0</span><span class="ru">tCO‚ÇÇe / year saved</span>
          </div>
          <p class="info-text"
            style="font-size:11px;color:var(--muted);margin-top:12px;border-top:1px solid var(--border);padding-top:8px;">
            Fuel EFs used are mass-based (kgCO‚ÇÇe/kg fuel). NCV is stored for future use but not applied to mass-based
            EFs.</p>
        </div>
      </div>
    </div><!-- end main-col -->

    <!-- RESULTS SIDEBAR -->
    <div class="side-col">
      <div id="validation-alert"></div>
      <div class="results-card">
        <div class="section-title">üìä Results Summary</div>
        <div class="total-box">
          <div class="label">Total Annual Savings</div>
          <div class="value" id="total-co2">0</div>
          <div class="unit">tCO‚ÇÇe / year</div>
        </div>
        <div class="total-box" style="background:rgba(28,171,226,0.08);border-color:rgba(28,171,226,0.3)">
          <div class="label">Project Lifetime Total</div>
          <div class="value" id="lifetime-co2" style="color:var(--accent2);font-size:32px">0</div>
          <div class="unit">tCO‚ÇÇe over <span id="lt-yrs">10</span> years</div>
        </div>
        <div class="total-box" style="background:rgba(16,185,129,0.08);border-color:rgba(16,185,129,0.3)">
          <div class="label">Indicative Gross Carbon Value</div>
          <div class="value" id="revenue-annual" style="color:var(--green);font-size:26px">$0</div>
          <div class="unit">Est. Annual Value (at $<span id="lbl-price">10</span>/t)<br><strong
              style="color:var(--text);margin-top:4px;display:inline-block;border-top:1px solid rgba(16,185,129,0.2);padding-top:4px;width:100%;">Lifetime:
              <span id="revenue-lifetime" style="color:var(--green)">$0</span></strong></div>
        </div>
        <div class="total-box" style="background:rgba(245,158,11,0.08);border-color:rgba(245,158,11,0.3)">
          <div class="label">Total Est. Fuel Cost Savings</div>
          <div class="value" id="fuel-annual" style="color:#d97706;font-size:26px">$0</div>
          <div class="unit">Avoided spending per year<br><strong
              style="color:var(--text);margin-top:4px;display:inline-block;border-top:1px solid rgba(245,158,11,0.2);padding-top:4px;width:100%;">Lifetime:
              <span id="fuel-lifetime" style="color:#d97706">$0</span></strong></div>
        </div>
        <div class="bar-wrap" id="bar-wrap">
          <div class="bar-item">
            <div class="bar-label"><span>‚ö° A ¬∑ Solar Pumping</span><span id="bar-a-val">0%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="bar-A" style="width:0%; background:#0ea5e9"></div>
            </div>
          </div>
          <div class="bar-item">
            <div class="bar-label"><span>‚ô®Ô∏è B ¬∑ Avoided Boiling</span><span id="bar-b-val">0%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="bar-B" style="width:0%; background:#ef4444"></div>
            </div>
          </div>
          <div class="bar-item">
            <div class="bar-label"><span>üç≥ C ¬∑ Inst Cooking</span><span id="bar-c-val">0%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="bar-C" style="width:0%; background:#f97316"></div>
            </div>
          </div>
          <div class="bar-item">
            <div class="bar-label"><span>üöΩ D ¬∑ Sanitation</span><span id="bar-d-val">0%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="bar-D" style="width:0%; background:#10b981"></div>
            </div>
          </div>
          <div class="bar-item">
            <div class="bar-label"><span>üî• E ¬∑ HH Cookstoves</span><span id="bar-e-val">0%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="bar-E" style="width:0%; background:#8b5cf6"></div>
            </div>
          </div>
          <div class="bar-item">
            <div class="bar-label"><span>üí° F ¬∑ Inst Lighting</span><span id="bar-f-val">0%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="bar-F" style="width:0%; background:#eab308"></div>
            </div>
          </div>
          <div class="bar-item">
            <div class="bar-label"><span>‚òÄÔ∏è G ¬∑ HH Induction</span><span id="bar-g-val">0%</span></div>
            <div class="bar-track">
              <div class="bar-fill" id="bar-G" style="width:0%; background:#db2777"></div>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="section-title"> Scale of Impact</div>
        <div class="equiv-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 16px;">
          <div class="equiv-item" style="background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2);">
            <div class="eico" style="color: var(--primary);">üë•</div>
            <div class="eval" id="impact-people" style="color: var(--primary);">0</div>
            <div class="elab">People Reached</div>
          </div>
          <div class="equiv-item" style="background: rgba(28,171,226,0.05); border: 1px solid rgba(28,171,226,0.2);">
            <div class="eico" style="color: var(--accent2);">üè•</div>
            <div class="eval" id="impact-inst" style="color: var(--accent2);">0</div>
            <div class="elab">Institutions Reached</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="section-title">üå± Equivalencies</div>
        <div class="equiv-grid">
          <div class="equiv-item">
            <div class="eico">üå≥</div>
            <div class="eval" id="eq-trees">0</div>
            <div class="elab">Trees preserved/yr</div>
          </div>
          <div class="equiv-item">
            <div class="eico">üöó</div>
            <div class="eval" id="eq-cars">0</div>
            <div class="elab">Cars off road/yr</div>
          </div>
          <div class="equiv-item">
            <div class="eico">‚úàÔ∏è</div>
            <div class="eval" id="eq-flights">0</div>
            <div class="elab">Long-haul flights</div>
          </div>
          <div class="equiv-item">
            <div class="eico">üí°</div>
            <div class="eval" id="eq-homes">0</div>
            <div class="elab">Homes powered/yr</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="section-title">üìÅ Export</div>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="exportCSV()">‚¨á CSV</button>
          <button class="btn btn-outline" onclick="window.print()">üñ® Print</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


    // Sanitation MCF values (IPCC 2006, Table 6.3)
    const MCF = {
      openwater: 0.30, opendry: 0.05, sharedpit: 0.50, septic: 0.50,
      vip: 0.05, ecosan: 0.01, biogas: 0.10, sewer: 0.00
    };

    // ‚îÄ‚îÄ‚îÄ STATE & SHARED LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let state = {
      country: 'MWI',
      results: { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0, G: 0 },
      fuelSavings: { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0, G: 0 },
      defaults: null
    };

    // Unified Fuel Engine
    const FuelEngine = {
      calculateEmissions: function (fuelType, massKg, fNRB) {
        if (!state.defaults) return 0;
        const fuelDef = state.defaults.fuels[fuelType];
        if (!fuelDef) return 0;

        const massT = massKg / 1000;
        let ER = 0;

        if (fuelType === 'wood') {
          // Both CO2 and NC are subject to fNRB for woody biomass
          ER = massT * (fuelDef.efCO2_kg_kg + fuelDef.efNC_kg_kg) * fNRB;
        } else if (fuelType === 'charcoal') {
          // Charcoal combustion: Apply to biogenic portion only if method dictates.
          // Constraint: Charcoal CO2 is net-zero (not counted); only non-CO2 is counted.
          const combER = massT * fuelDef.efNC_kg_kg;

          // Upstream Wood Production: mass * prodRatio * wood EFs
          const woodDef = state.defaults.fuels.wood;
          // Apply fNRB to both CO2 and NC portions for the upstream wood
          const upER = massT * fuelDef.prodRatio * (woodDef.efCO2_kg_kg + woodDef.efNC_kg_kg) * fNRB;
          ER = combER + upER;
        } else {
          // Fossil fuels - NO fNRB applied
          ER = massT * (fuelDef.efCO2_kg_kg + fuelDef.efNC_kg_kg);
        }
        return ER;
      }
    };

    // ‚îÄ‚îÄ‚îÄ CALCULATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calcA() {
      state.fuelSavings.A = 0;
      let BE_pump = 0;
      let BE_boil = 0;

      // --- Pump Displacement ---
      if (document.getElementById('tog-A').checked) {
        const Q = +v('A-demand');      // m¬≥/day
        const H = +v('A-head');        // m
        const days = +v('A-days');
        const etaP = +v('A-etapump');
        const base = v('A-baseline');
        // Hydraulic energy kWh/day = Q*H*rho*g / (3600*1000)
        const hydKwh = Q * H * 9.81 / 3600;  // kWh/day
        const shaftKwh = hydKwh / etaP;       // kWh/day

        if (base === 'diesel') {
          const etaD = +v('A-etadiesel');
          const LHV = 10.0;  // kWh/litre diesel (‚âà36 MJ/L)
          const dieselL = shaftKwh / (etaD * LHV) * days; // L/year
          BE_pump = dieselL * 2.68 / 1000; // tCO2/year (IPCC EF diesel)
          document.getElementById('A-formula').innerHTML =
            `Pump Displacement: Diesel <b>${(shaftKwh / (etaD * LHV)).toFixed(1)} L/day</b> <span class="info" title="Diesel (L/day) = (Volume(m¬≥/day) √ó Head(m) √ó 9.81 / 3600) / Pump_Œ∑ / (Engine_Œ∑ √ó 10 kWh/L)">i</span> √ó ${days} days √ó 2.68 kgCO‚ÇÇ/L = <b>${BE_pump.toFixed(1)} tCO‚ÇÇe/yr</b>`;

          // Fuel Savings (Pump)
          state.fuelSavings.A += dieselL * (+v('price-diesel'));
        } else {
          const etaM = +v('A-etamotor');
          const kwhYr = shaftKwh / etaM * days;
          const co = getLDC();
          BE_pump = kwhYr * co.gEF / 1000;
          document.getElementById('A-formula').innerHTML =
            `Pump Displacement: Grid <b>${kwhYr.toFixed(0)} kWh/yr</b> √ó ${co.gEF} kgCO‚ÇÇ/kWh = <b>${BE_pump.toFixed(1)} tCO‚ÇÇe/yr</b>`;
        }
      } else {
        document.getElementById('A-formula').innerHTML = `Pump Displacement: = <b>0 tCO‚ÇÇe/yr</b>`;
      }

      return BE_pump;
    }

    function calcB() {
      state.fuelSavings.B = 0;

      const hcfs = +v('port-hcfs');
      const schools = +v('port-schools');
      const hcfWater = document.getElementById('chk-hcf-water').checked;
      const schWater = document.getElementById('chk-sch-water').checked;
      const hcfBeds = +v('hcf-beds'), hcfOpd = +v('hcf-opd'), hcfStaff = +v('hcf-staff');
      const hcfPop = hcfBeds + Math.round(hcfOpd * 0.3) + hcfStaff;
      const schPupils = +v('sch-pupils'), schStaff = +v('sch-staff');
      const schPop = schPupils + schStaff;
      const commPopPerSystem = +v('A-comm-pop');

      const totalCommPop = (hcfs > 0 && hcfWater ? hcfs * commPopPerSystem : 0) + (schools > 0 && schWater ? schools * commPopPerSystem : 0);
      const hcfInstituPop = hcfs > 0 && hcfWater ? hcfs * hcfPop : 0;
      const schInstituPop = schools > 0 && schWater ? schools * schPop : 0;
      const totalPop = hcfInstituPop + schInstituPop + totalCommPop;

      document.getElementById('B-total-pop').textContent = Math.round(totalPop).toLocaleString();

      if (!document.getElementById('tog-B').checked) return 0;
      let BE_boil = 0;

      const boilVol = +v('B-boil-vol'); // L/person/day
      const boilFuel = v('B-fuel'); // 'wood' or 'charcoal'
      const boilEta = +v('B-boil-eta');
      const co = getLDC();
      const fNRB = co ? co.fNRB : 0.81;

      if (totalPop > 0 && boilVol > 0 && state.defaults && state.defaults.fuels) {
        // Energy to boil 1L of water from 20C to 100C + 5 min boiling (roughly 0.1 kWh or 0.36 MJ)
        // Specific heat of water: 4.184 kJ/kgC. 80C diff = 334.7 kJ. Latent heat/evaporation losses = ~0.36 MJ total per L.
        const energyPerL_MJ = 0.36;
        const totalEnergyRea_MJ_yr = totalPop * boilVol * 365 * energyPerL_MJ;

        const fuelDef = state.defaults.fuels[boilFuel];
        if (fuelDef) {
          const fuelNCV_MJ_kg = fuelDef.ncv_Mj_kg;
          // Total mass of fuel needed = (Useful Energy Required / NCV) / boiling efficiency
          const fuelMassKg_yr = (totalEnergyRea_MJ_yr / fuelNCV_MJ_kg) / boilEta;

          // Calculate emissions using FuelEngine
          BE_boil = FuelEngine.calculateEmissions(boilFuel, fuelMassKg_yr, fNRB);

          let formulaText = `Avoided Boiling: ${totalPop} pop √ó ${boilVol}L/d √ó 365d = ${(totalPop * boilVol * 365 / 1000).toFixed(1)} m¬≥/yr at Œ∑ ${Math.round(boilEta * 100)}% ‚Üí ${(fuelMassKg_yr / 1000).toFixed(1)} t ${boilFuel}/yr = <b>${BE_boil.toFixed(1)} tCO‚ÇÇe/yr</b>`;
          if (boilFuel === 'charcoal') {
            formulaText += ` <span class="info" title="Charcoal includes upstream wood-to-charcoal emissions using prodRatio from defaults. Charcoal CO2 treated as biogenic; non-CO2 counted.">i</span>`;
          }
          document.getElementById('B-formula').innerHTML = formulaText;

          // Fuel Savings (Boiling)
          state.fuelSavings.B = fuelMassKg_yr * (+v('price-' + boilFuel));
        }
      } else {
        document.getElementById('B-formula').innerHTML = `Avoided Boiling: = <b>0 tCO‚ÇÇe/yr</b>`;
      }

      return BE_boil;
    }

    function calcC() {
      state.fuelSavings.C = 0;
      // Also update institution pop regardless of toggle
      const popInst = (+v('hcf-beds') + +v('hcf-opd') + +v('hcf-staff')) * +v('port-hcfs') +
        (+v('sch-pupils') + +v('sch-staff')) * +v('port-schools');
      document.getElementById('C-total-pop').textContent = Math.round(popInst).toLocaleString();

      if (!document.getElementById('tog-C').checked) return 0;
      const fuelType = v('C-fuel');
      const fc_day = +v('C-fuelkg');   // kg/day
      const days = +v('C-days');
      const elec = v('C-elec');
      const co = getLDC();
      if (!co) return 0;
      const fNRB = co.fNRB;
      const fc_t = fc_day * days / 1000; // tonnes/year

      let BE = FuelEngine.calculateEmissions(fuelType, fc_day * days, fNRB);

      let PE = 0;
      if (elec === 'grid') {
        const kwh = +v('C-kwh');
        PE = kwh * co.gEF / 1000;
        document.getElementById('C-grid-fields').style.display = 'grid';
      } else {
        document.getElementById('C-grid-fields').style.display = 'none';
      }
      const er = Math.max(0, BE - PE);
      document.getElementById('C-formula').innerHTML =
        `BE = ${fc_t.toFixed(2)} t/yr <span class="info" title="Baseline Fuel (t/yr) = Daily_Consumption √ó Days_per_Year / 1000">i</span> √ó (EF<sub>CO2</sub>+EF<sub>NC</sub>) √ó fNRB = <b>${BE.toFixed(2)} tCO‚ÇÇe/yr</b> <br> PE = <b>${PE.toFixed(2)}</b> <span class="info" title="Project Emissions (PE) = Annual_Electricity_Use √ó Grid_Emission_Factor">i</span> ‚Üí ER = <b>${er.toFixed(2)} tCO‚ÇÇe/yr</b>`;

      // Fuel Savings: total kg of displaced fuel * price per kg
      const fuelPrice = +v('price-' + fuelType) || 0;
      state.fuelSavings.C = (fc_day * days) * fuelPrice;

      return er;
    }

    function calcD() {
      const U_inst = +v('D-pop-inst');
      const U_hh = +v('D-pop-hh');
      const popEl = document.getElementById('D-total-pop');
      if (popEl) popEl.textContent = Math.round(U_inst + U_hh).toLocaleString();

      if (!document.getElementById('tog-D').checked) return 0;
      const BOD = +v('D-bod') / 1000; // kg/person/day
      const Bo = +v('D-bo');

      const mcfB_inst = MCF[v('D-baseline-inst')];
      const mcfI_inst = MCF[v('D-improved-inst')];
      const dMCF_inst = Math.max(0, mcfB_inst - mcfI_inst);
      const ch4_inst = U_inst * BOD * 365 * Bo * dMCF_inst;

      const mcfB_hh = MCF[v('D-baseline-hh')];
      const mcfI_hh = MCF[v('D-improved-hh')];
      const dMCF_hh = Math.max(0, mcfB_hh - mcfI_hh);
      const ch4_hh = U_hh * BOD * 365 * Bo * dMCF_hh;

      const er = (ch4_inst + ch4_hh) * 28 / 1000;  // tCO2e/year (GWP AR5)
      document.getElementById('D-formula').innerHTML =
        `Inst: ${U_inst}p ¬∑ HH: ${U_hh}p √ó ${(BOD * 1000).toFixed(0)}g √ó 365 √ó ${Bo} Bo √ó ŒîMCF <span class="info" title="ŒîMCF = MCF_baseline - MCF_improved. It represents the reduced fraction of methane potential realized.">i</span> √ó GWP28 = <b>${er.toFixed(2)} tCO‚ÇÇe/yr</b>`;
      return er;
    }


    function calcF() {
      state.fuelSavings.F = 0;
      const popInst = (+v('hcf-beds') + +v('hcf-opd') + +v('hcf-staff')) * +v('port-hcfs') +
        (+v('sch-pupils') + +v('sch-staff')) * +v('port-schools');
      const popEl = document.getElementById('F-total-pop');
      if (popEl) popEl.textContent = Math.round(popInst).toLocaleString();

      if (!document.getElementById('tog-F').checked) return 0;
      const count = +v('F-count');
      const ef = +v('F-ef');
      const er = count * ef;
      document.getElementById('F-formula').innerHTML = `${count} facilities √ó ${ef} tCO‚ÇÇe/yr <span class="info" title="Baseline Emission Factor varies by replaced system (e.g. 2.5 tCO‚ÇÇe/yr/facility for Kerosene)">i</span> = <b>${er.toFixed(2)} tCO‚ÇÇe/yr</b>`;

      // Fuel Savings estimation
      // Kerosene EF: ~2.5 kgCO2/L. Diesel EF: ~2.68 kgCO2/L.
      // To estimate L from tCO2e, divide by EF.
      const baseline = v('F-baseline');
      if (baseline === 'kerosene') {
        const litersKero = (er * 1000) / 2.5;
        state.fuelSavings.F = litersKero * (+v('price-kerosene'));
      } else if (baseline === 'diesel') {
        const litersDiesel = (er * 1000) / 2.68;
        state.fuelSavings.F = litersDiesel * (+v('price-diesel'));
      }

      return er;
    }

    function calcG() {
      state.fuelSavings.G = 0;
      const count = +v('G-count');
      const hhSize = +v('hh-size');
      const popF = count * hhSize;
      const popEl = document.getElementById('G-total-pop');
      if (popEl) popEl.textContent = Math.round(popF).toLocaleString();

      if (!document.getElementById('tog-G').checked) return 0;
      const fcDay = +v('G-fc');
      const fuelT = v('G-fuel');
      const co = getLDC();
      if (!co) return 0;
      const fNRB = co.fNRB;

      const totalMassKg = fcDay * 365 * count;
      const ER = FuelEngine.calculateEmissions(fuelT, totalMassKg, fNRB);

      let formulaText = `${count} HHs √ó ${(totalMassKg / 1000).toFixed(2)} t/yr <span class="info" title="Baseline Mass (t/yr) = HHs √ó Daily_Fuel_per_HH √ó 365 / 1000">i</span> √ó (EF<sub>CO2</sub>+EF<sub>NC</sub>) √ó fNRB = <b>${ER.toFixed(2)} tCO‚ÇÇe/yr</b>`;
      if (fuelT === 'charcoal') {
        formulaText += ` <span class="info" title="Charcoal includes upstream wood-to-charcoal emissions using prodRatio from defaults. Charcoal CO2 treated as biogenic; non-CO2 counted.">i</span>`;
      }
      document.getElementById('G-formula').innerHTML = formulaText;

      // Fuel Savings: displaced kg * price per kg
      state.fuelSavings.G = totalMassKg * (+v('price-' + fuelT));

      return ER;
    }
    function calcE() {
      state.fuelSavings.E = 0;
      const N = +v('E-stoves');
      const hhSize = +v('hh-size');
      const popD = N * hhSize;
      const popEl = document.getElementById('E-total-pop');
      if (popEl) popEl.textContent = Math.round(popD).toLocaleString();

      if (!document.getElementById('tog-E').checked) return 0;
      const fcDay = +v('E-baseline-fc');
      const etaB = +v('E-base-stove');
      const etaI = +v('E-imp-stove');
      const fNRB = +v('E-fnrb');
      const stack = +v('E-stack');
      const fuelT = v('E-fuel');

      const fcYrKg = fcDay * 365;          // kg/stove/year (baseline)
      const FSKg = fcYrKg * (1 - etaB / etaI);    // fuel saved per stove/year (kg)

      const totalSavedKg = N * FSKg;
      const ER_gross = FuelEngine.calculateEmissions(fuelT, totalSavedKg, fNRB);
      const er = ER_gross * (1 - stack);

      let formulaText = `${N} stoves √ó ${(FSKg / 1000).toFixed(3)} t FS/yr <span class="info" title="Fuel Saved (FS) = Baseline_Fuel √ó (1 - Œ∑_baseline / Œ∑_improved)">i</span> √ó (EF<sub>CO2</sub>+EF<sub>NC</sub>) √ó fNRB √ó ${(1 - stack).toFixed(2)} (stack) <span class="info" title="Stacking factor accounts for continued use of baseline stoves (default 20% discount).">i</span> = <b>${er.toFixed(2)} tCO‚ÇÇe/yr</b>`;
      if (fuelT === 'charcoal') {
        formulaText += ` <span class="info" title="Charcoal includes upstream wood-to-charcoal emissions using prodRatio from defaults. Charcoal CO2 treated as biogenic; non-CO2 counted.">i</span>`;
      }
      document.getElementById('E-formula').innerHTML = formulaText;

      // Fuel Savings: displaced kg * price per kg * stack adjustment
      state.fuelSavings.E = (totalSavedKg * (1 - stack)) * (+v('price-' + fuelT));

      return er;
    }

    // ‚îÄ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function v(id) {
      const el = document.getElementById(id);
      return el ? el.value : 0;
    }
    function getLDC() { return state.defaults ? state.defaults.countries[state.country] : null; }
    function fmt(n) { return n < 1 ? n.toFixed(2) : n < 10 ? n.toFixed(1) : Math.round(n).toLocaleString(); }

    function recalc() {
      // Unconditionally evaluate calculations to update UI spans (formulas, pop counts)
      const resA = calcA();
      const resB = calcB();
      const resC = calcC();
      const resD = calcD();
      const resE = calcE();
      const resF = calcF();
      const resG = calcG();

      // Validation: Double counting overlap check
      const moduleEval = document.getElementById('tog-E').checked ? +v('E-stoves') : 0;
      const moduleGval = document.getElementById('tog-G').checked ? +v('G-count') : 0;

      let validationFailed = false;
      const alertBox = document.getElementById('validation-alert');
      // Block calculation strictly if both HH modules have active input > 0
      if (moduleEval > 0 && moduleGval > 0 && document.getElementById('tog-E').checked && document.getElementById('tog-G').checked) {
        alertBox.innerHTML = `<strong>‚ö†Ô∏è Double counting risk:</strong> Households cannot be included in both Module E (ICS) and Module G (HH induction). Split households between modules or set one module to zero.`;
        alertBox.style.display = 'block';
        validationFailed = true;

        // Highlight zeroed population due to double-counting block
        document.getElementById('E-total-pop').innerHTML = `<span style="color:var(--red)">0 (Blocked - Overlap)</span>`;
        document.getElementById('G-total-pop').innerHTML = `<span style="color:var(--red)">0 (Blocked - Overlap)</span>`;
      } else {
        alertBox.style.display = 'none';
      }

      state.results.A = validationFailed ? 0 : resA;
      state.results.B = validationFailed ? 0 : resB;
      state.results.C = validationFailed ? 0 : resC;
      state.results.D = validationFailed ? 0 : resD;
      state.results.E = validationFailed ? 0 : resE;
      state.results.F = validationFailed ? 0 : resF;
      state.results.G = validationFailed ? 0 : resG;

      ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(m => {
        const r = validationFailed ? 'Fix inputs' : fmt(state.results[m]);
        document.getElementById('result-' + m).textContent = r;
      });

      // Update inline detail text
      ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(m => {
        const el = document.getElementById(m + '-detail');
        if (el) el.textContent = validationFailed ? 'Fix inputs' : fmt(state.results[m]);
      });

      const total = validationFailed ? 0 : Object.values(state.results).reduce((a, b) => a + b, 0);
      const lt = +v('lifetime');
      document.getElementById('lbl-price').textContent = v('carbon-price');
      document.getElementById('total-co2').innerHTML = validationFailed ? '<span style="color:var(--red);font-size:18px;">Fix inputs</span>' : fmt(total);
      document.getElementById('lifetime-co2').innerHTML = validationFailed ? '<span style="color:var(--red);font-size:18px;">Fix inputs</span>' : fmt(total * lt);
      document.getElementById('lt-yrs').textContent = lt;
      const carbonPrice = +v('carbon-price');
      const revAnnual = total * carbonPrice;
      const revLifetime = revAnnual * lt;
      document.getElementById('revenue-annual').textContent = '$' + fmt(revAnnual);
      document.getElementById('revenue-lifetime').textContent = '$' + fmt(revLifetime);

      const totalFuel = Object.values(state.fuelSavings).reduce((a, b) => a + b, 0);
      document.getElementById('fuel-annual').textContent = '$' + fmt(totalFuel);
      document.getElementById('fuel-lifetime').textContent = '$' + fmt(totalFuel * lt);

      // Bars
      ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(m => {
        const pct = total > 0 ? (state.results[m] / total * 100) : 0;
        document.getElementById('bar-' + m).style.width = pct + '%';
        document.getElementById('bar-' + m.toLowerCase() + '-val').textContent = pct.toFixed(0) + '%';
      });

      // Equivalencies (EPA/IPCC standard factors)
      document.getElementById('eq-trees').textContent = Math.round(total * 16.5).toLocaleString(); // 1 tCO2 ‚âà 16.5 trees/yr
      document.getElementById('eq-cars').textContent = Math.round(total / 4.6).toLocaleString();   // avg car 4.6 tCO2/yr
      document.getElementById('eq-flights').textContent = Math.round(total / 0.9).toLocaleString();   // per flight ~0.9 tCO2
      document.getElementById('eq-homes').textContent = Math.round(total / 7.0).toLocaleString();   // US avg home 7 tCO2/yr

      // Impact Scale (People & Institutions)
      const isWater = document.getElementById('tog-A').checked;
      const hcfs = +v('port-hcfs');
      const schools = +v('port-schools');

      const isSan = document.getElementById('tog-D').checked;
      // We sum the baseline populations. 
      // If A is active, it includes community water pop. 
      // If a household module (D or F) or Module C is active, it includes household pop.

      let totInst = 0;
      if (document.getElementById('tog-C').checked || document.getElementById('tog-F').checked || isWater || isSan) {
        totInst = hcfs + schools;
      }

      // Get highest population between the modules to avoid double counting communities and households
      let popA = 0;
      if (isWater) {
        const popAStr = document.getElementById('A-total-pop').textContent.replace(/,/g, '');
        popA = parseInt(popAStr) || 0;
      }
      let popD_HH = 0;
      if (isSan) {
        popD_HH = parseInt(v('D-pop-hh')) || 0;
      }

      const checkEval = document.getElementById('tog-E').checked ? +v('E-stoves') : 0;
      const checkGval = document.getElementById('tog-G').checked ? +v('G-count') : 0;
      const hhSize = +v('hh-size') || 5;
      const popCooking = Math.max(checkEval, checkGval) * hhSize;

      // Estimate total individuals reached (combining institutional pops, community pop, and HH pops)
      // Since Module A naturally combines institution pop + community pop, we use that as the base if active
      let hcfInstituPop = hcfs > 0 ? hcfs * (+v('hcf-beds') + Math.round(+v('hcf-opd') * 0.3) + +v('hcf-staff')) : 0;
      let schInstituPop = schools > 0 ? schools * (+v('sch-pupils') + +v('sch-staff')) : 0;

      let baseInstPop = hcfInstituPop + schInstituPop;
      let totalPopReached = Math.max(popA, baseInstPop) + Math.max(popD_HH, popCooking);
      let overlapWarning = '';
      if (popD_HH > 0 && popCooking > 0) {
        overlapWarning = ' <span style="font-size:12px; color:var(--warn);" title="Overlap Possible: Same households may be reached by both Sanitation and Cooking interventions.">‚ö†Ô∏è</span>';
      }

      document.getElementById('impact-inst').textContent = validationFailed ? "0" : Math.round(totInst).toLocaleString();
      document.getElementById('impact-people').innerHTML = validationFailed ? "0" : Math.round(totalPopReached).toLocaleString() + overlapWarning;
    }

    function onCountryChange() {
      const iso = v('country');
      state.country = iso;
      const co = getLDC();
      if (!co) return;
      document.getElementById('badge-fnrb').textContent = co.fNRB.toFixed(2);
      document.getElementById('badge-grid').textContent = co.gEF.toFixed(3) + ' kgCO‚ÇÇ/kWh';
      document.getElementById('badge-region').textContent = co.r;
      const fDef = state.defaults.fuels[co.fuel];
      document.getElementById('badge-fuel').textContent = fDef ? fDef.label : co.fuel;
      // Auto-set fuel selects
      document.getElementById('C-fuel').value = co.fuel === 'charcoal' ? 'charcoal' : 'wood';
      document.getElementById('E-fuel').value = co.fuel === 'charcoal' ? 'charcoal' : 'wood';
      document.getElementById('E-fnrb').value = co.fNRB.toFixed(2);

      // Auto-set local fuel prices from defaults
      if (state.defaults && state.defaults.fuels) {
        ['wood', 'charcoal', 'lpg', 'kerosene', 'diesel'].forEach(f => {
          const input = document.getElementById('price-' + f);
          if (input && state.defaults.fuels[f] && state.defaults.fuels[f].price_usd !== undefined) {
            input.value = state.defaults.fuels[f].price_usd.toFixed(2);
          }
        });
      }

      recalc();
    }



    function onTypeParamChange(force = false) {
      // Exclusivity for HH Checkboxes
      if (document.activeElement && document.activeElement.id === 'chk-hh-cook' && document.getElementById('chk-hh-cook').checked) {
        document.getElementById('chk-hh-ind').checked = false;
      } else if (document.activeElement && document.activeElement.id === 'chk-hh-ind' && document.getElementById('chk-hh-ind').checked) {
        document.getElementById('chk-hh-cook').checked = false;
      }

      const hcfs = +v('port-hcfs');
      const schools = +v('port-schools');
      const hhs = +v('port-hhs');

      // Flags
      const hcfWater = document.getElementById('chk-hcf-water').checked;
      const hcfSan = document.getElementById('chk-hcf-san').checked;
      const hcfCook = document.getElementById('chk-hcf-cook').checked;
      const hcfLight = document.getElementById('chk-hcf-light').checked;

      const schWater = document.getElementById('chk-sch-water').checked;
      const schSan = document.getElementById('chk-sch-san').checked;
      const schCook = document.getElementById('chk-sch-cook').checked;
      const schLight = document.getElementById('chk-sch-light').checked;

      const hhCook = document.getElementById('chk-hh-cook').checked;
      const hhInd = document.getElementById('chk-hh-ind').checked;
      const hhSan = document.getElementById('chk-hh-san').checked;

      const hcfBeds = +v('hcf-beds'), hcfOpd = +v('hcf-opd'), hcfStaff = +v('hcf-staff'), hcfDays = +v('hcf-days') || 365;
      const hcfPop = hcfBeds + Math.round(hcfOpd * 0.3) + hcfStaff;
      const hcfWaterPerDay = (hcfBeds * 75 + hcfOpd * 5) / 1000;

      const schPupils = +v('sch-pupils'), schStaff = +v('sch-staff'), schDays = +v('sch-days') || 200, schMeals = +v('sch-meals');
      const schPop = schPupils + schStaff;
      const schWaterPerDay = (schPop * 3) / 1000;
      const schFuelKgPerDay = schMeals * 0.10;

      const hhCountTotal = +v('hh-count');
      const hhSize = +v('hh-size');
      const hhPop = hhCountTotal * hhSize;

      // Assumed 100% penetration for the active checkbox
      const stoveRatio = hhCook ? 1.0 : 0;
      const indRatio = hhInd ? 1.0 : 0;

      // Module E: Cookstoves
      const dHouseholds = Math.round(hhs * hhCountTotal * stoveRatio * (1 - indRatio));
      // Only forcibly override individual module inputs if changes come from the top portfolio fields
      if (force || (document.activeElement && document.activeElement.id.startsWith('chk-hh'))) {
        document.getElementById('E-stoves').value = dHouseholds;
      } else if (!document.getElementById('E-stoves').value) {
        document.getElementById('E-stoves').value = dHouseholds; // init
      }

      // Module G: HH Induction
      const fHouseholds = Math.round(hhs * hhCountTotal * indRatio);
      if (force || (document.activeElement && document.activeElement.id.startsWith('chk-hh'))) {
        document.getElementById('G-count').value = fHouseholds;
      } else if (!document.getElementById('G-count').value) {
        document.getElementById('G-count').value = fHouseholds; // init
      }

      // Community expansion for water (configurable pop per installation)
      const commPopPerSystem = +v('A-comm-pop');
      const totalCommPop = (hcfs > 0 && hcfWater ? hcfs * commPopPerSystem : 0) + (schools > 0 && schWater ? schools * commPopPerSystem : 0);

      // Calculate Total Population Served for Module A
      const hcfInstituPop = hcfs > 0 && hcfWater ? hcfs * hcfPop : 0;
      const schInstituPop = schools > 0 && schWater ? schools * schPop : 0;
      const totalPopServedA = hcfInstituPop + schInstituPop + totalCommPop;

      document.getElementById('A-total-pop').textContent = Math.round(totalPopServedA).toLocaleString();

      // Assume 20L per person per day for the community
      const commWaterPerDay = (commPopPerSystem * 20) / 1000;

      // If not triggered by portfolio, just let it recalculate
      if (force || (document.activeElement && (document.activeElement.id.startsWith('chk-') || document.activeElement.id.startsWith('port-')))) {
        // Module A: Water
        const hcfWaterTotal = hcfs > 0 && hcfWater ? (hcfs * hcfWaterPerDay * hcfDays) + (hcfs * commWaterPerDay * 365) : 0;
        const schWaterTotal = schools > 0 && schWater ? (schools * schWaterPerDay * schDays) + (schools * commWaterPerDay * 365) : 0;
        const totalWaterAnnual = hcfWaterTotal + schWaterTotal;
        document.getElementById('A-demand').value = totalWaterAnnual > 0 ? (totalWaterAnnual / 365).toFixed(2) : 0;

        // Module C: Cooking
        const hcfFuelPerDay = hcfPop * 0.15;
        const totalFuelAnnual = (hcfs > 0 && hcfCook ? hcfs * hcfFuelPerDay * hcfDays : 0) + (schools > 0 && schCook ? schools * schFuelKgPerDay * schDays : 0);
        document.getElementById('C-fuelkg').value = totalFuelAnnual > 0 ? (totalFuelAnnual / 365).toFixed(1) : 0;
      } else if (!document.getElementById('A-demand').value) {
        // Initialization if empty
        const hcfWaterTotal = hcfs > 0 && hcfWater ? (hcfs * hcfWaterPerDay * hcfDays) + (hcfs * commWaterPerDay * 365) : 0;
        const schWaterTotal = schools > 0 && schWater ? (schools * schWaterPerDay * schDays) + (schools * commWaterPerDay * 365) : 0;
        const totalWaterAnnual = hcfWaterTotal + schWaterTotal;
        document.getElementById('A-demand').value = totalWaterAnnual > 0 ? (totalWaterAnnual / 365).toFixed(2) : 0;

        const hcfFuelPerDay = hcfPop * 0.15;
        const totalFuelAnnual = (hcfs > 0 && hcfCook ? hcfs * hcfFuelPerDay * hcfDays : 0) + (schools > 0 && schCook ? schools * schFuelKgPerDay * schDays : 0);
        document.getElementById('C-fuelkg').value = totalFuelAnnual > 0 ? (totalFuelAnnual / 365).toFixed(1) : 0;
      }

      // Module D: Sanitation
      const instPop = (hcfs > 0 && hcfSan ? hcfs * hcfPop : 0) + (schools > 0 && schSan ? schools * schPop : 0);
      const hhSanPop = (hhs > 0 && hhSan ? hhs * hhPop : 0);
      if (force || (document.activeElement && (document.activeElement.id.startsWith('chk-') || document.activeElement.id.startsWith('port-')))) {
        document.getElementById('D-pop-inst').value = instPop;
        document.getElementById('D-pop-hh').value = hhSanPop;
      } else if (!document.getElementById('D-pop-inst').value) {
        document.getElementById('D-pop-inst').value = instPop;
        document.getElementById('D-pop-hh').value = hhSanPop;
      }

      // Module F: Lighting
      if (force || (document.activeElement && (document.activeElement.id.startsWith('chk-') || document.activeElement.id.startsWith('port-')))) {
        document.getElementById('F-count').value = (hcfs > 0 && hcfLight ? hcfs : 0) + (schools > 0 && schLight ? schools : 0);
      } else if (!document.getElementById('F-count').value) {
        document.getElementById('F-count').value = (hcfs > 0 && hcfLight ? hcfs : 0) + (schools > 0 && schLight ? schools : 0);
      }

      recalc();
    }

    function toggleBody(m) {
      document.getElementById('body-' + m).classList.toggle('open');
    }
    function toggleModule(m) {
      document.getElementById('tog-' + m).setAttribute('data-user-toggled', 'true');
      recalc();
    }

    function exportCSV() {
      const co = getLDC();
      if (!co) {
        alert("Defaults not loaded yet. Please wait.");
        return;
      }
      const lt = +v('lifetime');
      const tot = Object.values(state.results).reduce((a, b) => a + b, 0);

      // Helper to cleanly export textContent from spans
      function t(id) { const el = document.getElementById(id); return el ? el.textContent : ''; }

      const hcfs = +v('port-hcfs');
      const schools = +v('port-schools');
      const hhs = +v('port-hhs');

      // Shared Module C
      const popInst = +v('D-pop-inst');
      const popHh = +v('D-pop-hh');

      const hcfBeds = +v('hcf-beds'), hcfOpd = +v('hcf-opd'), hcfStaff = +v('hcf-staff'), hcfDays = +v('hcf-days');
      const schPupils = +v('sch-pupils'), schMeals = +v('sch-meals'), schStaff = +v('sch-staff'), schDays = +v('sch-days');
      const hhCount = +v('hh-count'), hhSize = +v('hh-size');

      const popElement = document.getElementById('A-total-pop');
      const totalPopServedA = popElement ? popElement.textContent : '0';

      const rows = [
        ['CO2 Savings Calculator - Gold Standard Methodology', '', ''],
        ['Country', co.name, ''],
        ['Project Currency Year', v('creditYear'), ''],
        ['Project Lifetime (Years)', lt, ''],
        ['Carbon Price ($/tCO2e)', v('carbon-price'), ''],
        ['fNRB (Fraction Non-Renewable Biomass)', co.fNRB, ''],
        ['Grid EF (kgCO2/kWh)', co.gEF, ''],
        ['', '', ''],
        ['LOCAL FUEL PRICES USED (USD)', 'Price', 'Unit'],
        ['Firewood', v('price-wood'), '$/kg'],
        ['Charcoal', v('price-charcoal'), '$/kg'],
        ['LPG', v('price-lpg'), '$/kg'],
        ['Kerosene', v('price-kerosene'), '$/L'],
        ['Diesel', v('price-diesel'), '$/L'],
        ['', '', ''],
        ['PORTFOLIO INPUTS', 'Count', 'Details'],
        ['Health Care Facilities', hcfs, `${hcfBeds} Beds, ${hcfOpd} OPD/day, ${hcfStaff} Staff`],
        ['Schools / Institutions', schools, `${schPupils} Pupils, ${schStaff} Staff, ${schMeals} Meals/day`],
        ['Household Clusters', hhs, `${hhCount} HHs per cluster, ${hhSize} persons/HH`],
        ['', '', ''],
        ['MODULE A: SOLAR WATER PUMPING', 'Value', 'Unit'],
        ['Total Daily Water Demand (Pumping)', v('A-demand'), 'm3/day'],
        ['Pumping Head', v('A-head'), 'm'],
        ['Pump Efficiency', v('A-etapump'), ''],
        ['Baseline System', v('A-baseline'), ''],
        ['Community Size (Per Water System)', v('A-comm-pop'), 'persons'],
        ['Total Wash/Water Population Served (Module A)', totalPopServedA, 'persons'],
        ['', '', ''],
        ['MODULE B: AVOIDED BOILING', 'Value', 'Unit'],
        ['Avoided Boiling population served', t('B-total-pop'), 'persons'],
        ['Avoided Boiling - Baseline Fuel', v('B-fuel'), ''],
        ['Avoided Boiling - Drinking Water Vol', v('B-boil-vol'), 'L/person/day'],
        ['Avoided Boiling - Stove Efficiency', v('B-boil-eta'), ''],
        ['', '', ''],
        ['MODULE C: INSTITUTIONAL INDUCTION COOKING', 'Value', 'Unit'],
        ['Baseline Fuel Type', v('C-fuel'), ''],
        ['Daily Fuel Consumption', v('C-fuelkg'), 'kg/day'],
        ['Cooking Days/Year', v('C-days'), 'days/yr'],
        ['Electricity Source', v('C-elec'), ''],
        ['Grid Annual Electricity Use (if grid)', v('C-kwh'), 'kWh/yr'],
        ['', '', ''],
        ['MODULE D: SANITATION METHANE REDUCTION', 'Value', 'Unit'],
        ['Institutional Population Served', v('D-pop-inst'), 'persons'],
        ['Institutional Baseline System', v('D-baseline-inst'), ''],
        ['Institutional Improved System', v('D-improved-inst'), ''],
        ['Household Population Served', v('D-pop-hh'), 'persons'],
        ['Household Baseline System', v('D-baseline-hh'), ''],
        ['Household Improved System', v('D-improved-hh'), ''],
        ['BOD Load', v('D-bod'), 'g/person/day'],
        ['Max CH4 potential (Bo)', v('D-bo'), 'kg CH4/kg BOD'],
        ['', '', ''],
        ['MODULE E: IMPROVED HH COOKSTOVES', 'Value', 'Unit'],
        ['Number of Stoves/HH units', v('E-stoves'), 'stoves'],
        ['Baseline Fuel Type', v('E-fuel'), ''],
        ['Baseline Fuel Consumption', v('E-baseline-fc'), 'kg/HH/day'],
        ['Baseline Stove Efficiency', v('E-base-stove'), ''],
        ['Improved Stove Efficiency', v('E-imp-stove'), ''],
        ['fNRB applied', v('E-fnrb'), ''],
        ['Stacking Discount', v('E-stack'), ''],
        ['', '', ''],
        ['MODULE F: INSTITUTIONAL SOLAR LIGHTING', 'Value', 'Unit'],
        ['Number of Facilities', v('F-count'), 'facilities'],
        ['Baseline Fuel System', v('F-baseline'), ''],
        ['Baseline Emissions factor', v('F-ef'), 'tCO2e/yr/facility'],
        ['', '', ''],
        ['MODULE G: HH INDUCTION COOKING + SOLAR', 'Value', 'Unit'],
        ['Number of Households', v('G-count'), 'HHs'],
        ['Baseline Fuel Type', v('G-fuel'), ''],
        ['Daily Fuel Consumption', v('G-fc'), 'kg/HH/day'],
        ['', '', ''],
        ['RESULTS', 'Annual tCO2e/yr', 'Lifetime tCO2e'],
        ['A - Solar Water Pumping', state.results.A.toFixed(2), (state.results.A * lt).toFixed(1)],
        ['B - Avoided Boiling', state.results.B.toFixed(2), (state.results.B * lt).toFixed(1)],
        ['C - Institutional Induction Cooking', state.results.C.toFixed(2), (state.results.C * lt).toFixed(1)],
        ['D - Sanitation Methane Reduction', state.results.D.toFixed(2), (state.results.D * lt).toFixed(1)],
        ['E - Improved HH Cookstoves', state.results.E.toFixed(2), (state.results.E * lt).toFixed(1)],
        ['F - Institutional Solar Lighting', state.results.F.toFixed(2), (state.results.F * lt).toFixed(1)],
        ['G - HH Induction Cooking + Solar', state.results.G.toFixed(2), (state.results.G * lt).toFixed(1)],
        ['TOTAL EMISSION REDUCTIONS', tot.toFixed(2), (tot * lt).toFixed(1)],
        ['TOTAL ESTIMATED REVENUE', '$' + (tot * v('carbon-price')).toFixed(2), '$' + (tot * lt * v('carbon-price')).toFixed(2)],
        ['', '', ''],
        ['FINANCIAL SAVINGS', 'Annual Savings (USD)', 'Lifetime Savings (USD)'],
        ['A - Diesel Fuel Displaced (Pump)', state.fuelSavings.A.toFixed(2), (state.fuelSavings.A * lt).toFixed(2)],
        ['B - Boiling Fuel Displaced', state.fuelSavings.B.toFixed(2), (state.fuelSavings.B * lt).toFixed(2)],
        ['C - Cooking Fuel Displaced (Inst)', state.fuelSavings.C.toFixed(2), (state.fuelSavings.C * lt).toFixed(2)],
        ['D - Sanitation (No Fuel Savings)', '0.00', '0.00'],
        ['E - Cooking Fuel Displaced (HH)', state.fuelSavings.E.toFixed(2), (state.fuelSavings.E * lt).toFixed(2)],
        ['F - Lighting Fuel Displaced (Inst)', state.fuelSavings.F.toFixed(2), (state.fuelSavings.F * lt).toFixed(2)],
        ['G - Cooking Fuel Displaced (HH)', state.fuelSavings.G.toFixed(2), (state.fuelSavings.G * lt).toFixed(2)],
        ['TOTAL ESTIMATED FUEL COST SAVINGS', '$' + Object.values(state.fuelSavings).reduce((a, b) => a + b, 0).toFixed(2), '$' + (Object.values(state.fuelSavings).reduce((a, b) => a + b, 0) * lt).toFixed(2)],
        ['', '', ''],
        ['ASSUMPTIONS & FLAGS', '', ''],
        ['Mass-Based EFs Used?', 'Yes', 'UI and computation structurally avoids NCV'],
        ['Charcoal Upstream Production Included?', 'Yes', ''],
        ['Charcoal CO2 Counted?', 'No (Biogenic / Net-Zero)', ''],
        ['Charcoal prodRatio Used', state.defaults && state.defaults.fuels && state.defaults.fuels.charcoal ? state.defaults.fuels.charcoal.prodRatio : 'N/A', 'kg wood / kg char'],
        ['Validation Status', document.getElementById('validation-alert').style.display === 'block' ? 'FAILED (Overlap Risk)' : 'PASS', ''],
        ['', '', ''],
        ['DATA PROVENANCE', '', ''],
        ['Defaults Version', state.defaults ? state.defaults.version : 'Unknown', ''],
        ['Source', state.defaults ? state.defaults.metadata.source : 'Unknown', ''],
        ['', '', ''],
        ['METHODOLOGY REFERENCES', '', ''],
        ['A: Pumping - Gold Standard AMS-I.F / CDM AM0020', 'https://cdm.unfccc.int/methodologies/DB/9KJWQ1G0WEG6LKHX21MLPS8BQR7242', ''],
        ['B: Avoided Boiling - GS Safe Water Supply Methodology', 'https://globalgoals.goldstandard.org/standards/443_v1.0_ee_gs-methodology-for-emission-reductions-from-safe-drinking-water-supply/', ''],
        ['C: Gold Standard MECD v1.2', 'https://globalgoals.goldstandard.org/standards/431_V1.2_TC_EE_ICS_Methodology-for-Metered-and-Measured-Energy-Cooking-Devices.pdf', ''],
        ['D: IPCC / GS Integrated SDG Sanitation', 'https://globalgoals.goldstandard.org/in-development/integrated-sdg-methodology-for-sanitation/', ''],
        ['E: Gold Standard TPDDTEC / AMS-II.G', 'https://globalgoals.goldstandard.org/standards/407_V4.0_EE_ICS_Reduced-Emissions-from-Cooking-and-Heating-TPDDTEC.pdf', ''],
        ['F: Gold Standard AMS-III.AR', 'https://cdm.unfccc.int/methodologies/DB/S3RZMK6KR289WKK0VB1ETT6K73Y3DR', ''],
        ['G: Gold Standard MECD v1.2', 'https://globalgoals.goldstandard.org/standards/431_V1.2_TC_EE_ICS_Methodology-for-Metered-and-Measured-Energy-Cooking-Devices.pdf', ''],
      ];
      const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const a = document.createElement('a');
      a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csv);
      a.download = `CO2_Savings_${co.name.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
    }

    // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (async function init() {
      try {
        const res = await fetch('defaults.json');
        state.defaults = await res.json();
      } catch (e) {
        console.error("Failed to load defaults.json. Falling back to internal data.");
        // Fallback or error handled appropriately
      }

      if (state.defaults) {
        const sel = document.getElementById('country');
        const defaultLDC = state.defaults.countries;
        Object.keys(defaultLDC).sort((a, b) => defaultLDC[a].name.localeCompare(defaultLDC[b].name)).forEach(iso => {
          const o = document.createElement('option');
          o.value = iso; o.textContent = defaultLDC[iso].name + ' (' + defaultLDC[iso].r + ')';
          if (iso === 'MWI') o.selected = true;
          sel.appendChild(o);
        });
      }

      // Diesel/grid field toggle
      document.getElementById('A-baseline').addEventListener('change', function () {
        const isDiesel = this.value === 'diesel';
        document.getElementById('A-diesel-field').style.display = isDiesel ? 'flex' : 'none';
        document.getElementById('A-grid-field').style.display = isDiesel ? 'none' : 'flex';
      });
      onCountryChange();
      onTypeParamChange(true);
      window.scrollTo(0, 0);
    })();

  </script>
</body>

</html>